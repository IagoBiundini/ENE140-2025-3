import telebot
import io
import cv2
import whisper
import tensorflow as tf
import tensorflow_hub as hub
import librosa
import csv
import os
import numpy as np
from ultralytics import YOLO

class ClassificadorAudio:
    def __init__(self):
        print("Carregando YAMNet...")
        self.model = hub.load('https://tfhub.dev/google/yamnet/1')
        class_map_path = self.model.class_map_path().numpy().decode('utf-8')
        self.class_names = self._ler_labels(class_map_path)

    def _ler_labels(self, path):
        classes = []
        with tf.io.gfile.GFile(path) as f:
            reader = csv.DictReader(f)
            for row in reader:
                classes.append(row['display_name'])
        return classes

    def identificar_som(self, arquivo_memoria):
        arquivo_memoria.seek(0)
        audio, sr = librosa.load(arquivo_memoria, sr=16000, mono=True)
        scores, _, _ = self.model(audio)
        media_scores = tf.reduce_mean(scores, axis=0)
        idx_max = tf.argmax(media_scores)
        return self.class_names[idx_max], media_scores[idx_max].numpy()

class TranscritorWhisper:
    def __init__(self):
        modelo = input("Modelo do Whisper (tiny/base/large): ")
        print(f"Carregando Whisper (modelo {modelo})...")
        self.model = whisper.load_model(modelo)

    def transcrever(self, arquivo_memoria):
        arquivo_memoria.seek(0)
        with open("temp_audio.ogg", "wb") as f:
            f.write(arquivo_memoria.getbuffer())
        resultado = self.model.transcribe("temp_audio.ogg", fp16=False)
        return resultado['text']

class ClassificadorImagem:
    def __init__(self):
        print("Carregando YOLOv8n.pt...")
        self.model = YOLO("yolov8n.pt")

    def classificar_imagem(self, arquivo_memoria):
        arquivo_memoria.seek(0)
        file_bytes = np.asarray(bytearray(arquivo_memoria.read()), dtype=np.uint8)
        image = cv2.imdecode(file_bytes, cv2.IMREAD_COLOR)
        if image is None: return None, "Erro na imagem."
        
        result = self.model(image)
        name_class = result[0].names
        caption_parts = []
        for box in result[0].boxes:
            class_id = int(box.cls)
            conf = float(box.conf) * 100
            x1, y1, x2, y2 = map(int, box.xyxy[0])
            cv2.rectangle(image, (x1, y1), (x2, y2), (0, 0, 255), 2)
            cv2.putText(image, f"{name_class[class_id]} {conf:.1f}%", (x1, max(y1-10, 40)), 
                        cv2.FONT_HERSHEY_SIMPLEX, 0.6, (0, 0, 255), 2)
            caption_parts.append(f"{name_class[class_id]} ({conf:.1f}%)")
        
        legenda = "Objetos: " + ", ".join(caption_parts) if caption_parts else "Nenhum objeto."
        return image, legenda

class BotTelegram:
    def __init__(self, token, **kwargs):
        self.bot = telebot.TeleBot(token)

    def _configurar_handlers(self):
        @self.bot.message_handler(commands=['start'])
        def start(message):
            nome = message.from_user.first_name
            self.bot.reply_to(message, f"Ol√°, {nome}! Envie √°udios ou imagens para an√°lise.")

        @self.bot.message_handler(content_types=['video', 'sticker', 'animation', 'video_note', 'document', 'poll'])
        def responder(message):
            self.bot.reply_to(message, "Desculpe, n√£o trabalhamos com esse tipo de arquivo.")

        @self.bot.message_handler(content_types=['text'])
        def texto(message):
            self.bot.reply_to(message, "Desculpe, s√≥ processo imagens e √°udios.")

    def executar(self):
        print("Bot Online...")
        self.bot.infinity_polling()

class BotAudio(BotTelegram):
    def __init__(self, token, motor_som, motor_texto, **kwargs):
        super().__init__(token=token, **kwargs)
        self.classificador_audio = motor_som
        self.transcritor = motor_texto

    def _configurar_handlers_audio(self):
        super()._configurar_handlers()
        @self.bot.message_handler(content_types=['voice', 'audio'])
        def tratar_audio(message):
            status = self.bot.reply_to(message, "‚è≥ Analisando √°udio...")
            try:
                file_info = self.bot.get_file(message.voice.file_id if message.voice else message.audio.file_id)
                audio_ram = io.BytesIO(self.bot.download_file(file_info.file_path))
                classe, conf = self.classificador_audio.identificar_som(audio_ram)
                res = f"‚úÖ Som: {classe} ({conf:.2%})\n"
                if "Speech" in classe or "Conversation" in classe:
                    res += f"üìù Texto: {self.transcritor.transcrever(audio_ram)}"
                self.bot.send_message(message.chat.id, res)
                self.bot.delete_message(message.chat.id, status.message_id)
            except Exception as e:
                self.bot.reply_to(message, f"Erro: {e}")

class BotImagem(BotTelegram):
    def __init__(self, token, motor_imagem, **kwargs):
        super().__init__(token=token, **kwargs)
        self.classificador_imagem = motor_imagem

    def _configurar_handlers_image(self):
        @self.bot.message_handler(content_types=['photo'])
        def tratar_foto(message):
            status = self.bot.reply_to(message, "‚è≥ Analisando imagem...")
            try:
                file_id = message.photo[-1].file_id
                imagem_ram = io.BytesIO(self.bot.download_file(self.bot.get_file(file_id).file_path))
                img_res, legenda = self.classificador_imagem.classificar_imagem(imagem_ram)
                if img_res is not None:
                    _, enc = cv2.imencode('.png', img_res)
                    self.bot.send_photo(message.chat.id, io.BytesIO(enc.tobytes()), caption=legenda)
                self.bot.delete_message(message.chat.id, status.message_id)
            except Exception as e:
                self.bot.reply_to(message, f"Erro: {e}")

class BotAdmin(BotAudio, BotImagem):
    def __init__(self, token, motor_som, motor_texto, motor_imagem, **kwargs):
        super().__init__(token=token, motor_som=motor_som, motor_texto=motor_texto, motor_imagem=motor_imagem, **kwargs)
        self._configurar_handlers_image()
        self._configurar_handlers_audio()

if __name__ == "__main__":
    TOKEN = '8527216872:AAFhfx8OEsp3aBgUVN2qLM5UWksvwXjc_Jg'
    meu_bot = BotAdmin(token=TOKEN, motor_som=ClassificadorAudio(), motor_texto=TranscritorWhisper(), motor_imagem=ClassificadorImagem())
    meu_bot.executar()
